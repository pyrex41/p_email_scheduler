{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <h2>{{ org_name }} (ID: {{ org_id }})</h2>
    <p class="text-muted">
        Showing {{ sample_size }} contacts out of {{ total_contacts }} total contacts
        {% if selected_state %}
        (Filtered by state: {{ selected_state }})
        {% elif special_rules_only %}
        (Showing only states with special rules)
        {% endif %}
        <form action="/check" method="post" class="d-inline ms-3">
            <input type="hidden" name="org_id" value="{{ org_id }}">
            <input type="hidden" name="state" value="{{ selected_state }}">
            <input type="hidden" name="special_rules_only" value="{{ 'true' if special_rules_only else 'false' }}">
            <select class="form-select form-select-sm d-inline w-auto" name="sample_size" onchange="this.form.submit()">
                {% for size in sample_sizes %}
                <option value="{{ size }}" {% if size == sample_size %}selected{% endif %}>Show {{ size }} contacts</option>
                {% endfor %}
            </select>
        </form>
        <button class="btn btn-primary btn-sm ms-2" onclick="resampleContacts()">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Resample Contacts
        </button>
    </p>
</div>

<div id="contacts-container">
    {% for contact_id, contact_data in contacts.items() %}
    <div class="card contact-card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                {{ contact_data.contact_info.name }}
                <small class="text-muted">(ID: {{ contact_data.contact_info.id }})</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>Email:</strong> {{ contact_data.contact_info.email }}
                </div>
                <div class="col-md-4">
                    <strong>Birth Date:</strong> {{ contact_data.contact_info.birth_date or 'N/A' }}
                </div>
                <div class="col-md-4">
                    <strong>Effective Date:</strong> {{ contact_data.contact_info.effective_date or 'N/A' }}
                </div>
            </div>
            
            <div class="row">
                <!-- State and Rule Info -->
                <div class="col-md-4">
                    <div class="card border-info mb-3">
                        <div class="card-header bg-info text-white">
                            <strong>State: {{ contact_data.contact_info.state }}</strong>
                            {% if contact_data.contact_info.state_info.has_birthday_rule or 
                                contact_data.contact_info.state_info.has_effective_date_rule or 
                                contact_data.contact_info.state_info.has_year_round_enrollment %}
                            <span class="badge bg-light text-dark">Special Rules Apply</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if contact_data.contact_info.state_info.has_year_round_enrollment %}
                            <div class="alert alert-warning">
                                <strong>Year-Round Enrollment State</strong>
                                <p class="mb-0 small">All emails are skipped because this state allows year-round enrollment.</p>
                            </div>
                            {% endif %}
                            
                            {% if contact_data.contact_info.state_info.has_birthday_rule %}
                            <div class="mb-2">
                                <strong class="text-primary">Birthday Rule</strong>
                                <p class="mb-0 small">
                                    {% if contact_data.contact_info.state == "CA" %}
                                    60-day exclusion period: 30 days before and 30 days after birthday.
                                    {% elif contact_data.contact_info.state == "ID" %}
                                    63-day exclusion period: Starting on birthday and ending 63 days after.
                                    {% elif contact_data.contact_info.state == "IL" %}
                                    45-day exclusion period: Starting on birthday and ending 45 days after.
                                    {% elif contact_data.contact_info.state == "KY" %}
                                    60-day exclusion period: Starting on birthday and ending 60 days after.
                                    {% elif contact_data.contact_info.state == "LA" %}
                                    93-day exclusion period: 30 days before and 63 days after birthday.
                                    {% elif contact_data.contact_info.state == "MD" %}
                                    31-day exclusion period: Starting on birthday and ending 31 days after.
                                    {% elif contact_data.contact_info.state == "NV" %}
                                    60-day exclusion period: Starting on first day of birth month.
                                    {% elif contact_data.contact_info.state == "OK" %}
                                    60-day exclusion period: Starting on birthday and ending 60 days after.
                                    {% elif contact_data.contact_info.state == "OR" %}
                                    31-day exclusion period: Starting on birthday and ending 31 days after.
                                    {% endif %}
                                </p>
                            </div>
                            {% endif %}
                            
                            {% if contact_data.contact_info.state_info.has_effective_date_rule %}
                            <div class="mb-2">
                                <strong class="text-success">Effective Date Rule</strong>
                                <p class="mb-0 small">
                                    {% if contact_data.contact_info.state == "MO" %}
                                    63-day exclusion period: 30 days before and 33 days after the policy anniversary.
                                    {% endif %}
                                </p>
                            </div>
                            {% endif %}
                            
                            <div class="mb-0 small text-muted">
                                <p class="mb-0"><strong>Standard Scheduling Rules:</strong></p>
                                <ul class="ps-3 mb-0">
                                    <li>Birthday emails: 14 days before birthday</li>
                                    <li>Effective date emails: 30 days before anniversary</li>
                                    <li>AEP emails: Distributed across August/September</li>
                                    <li>Post-window emails: Day after exclusion period</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Scheduled Emails Section -->
                <div class="col-md-8">
                    <h6>Scheduled Emails:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Default Date</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for email in contact_data.emails %}
                                <tr {% if email.skipped == 'Yes' %}class="table-danger"{% endif %}>
                                    <td>
                                        {% if email.type == 'birthday' %}
                                        <span class="badge bg-primary">Birthday</span>
                                        {% elif email.type == 'effective_date' %}
                                        <span class="badge bg-success">Effective Date</span>
                                        {% elif email.type == 'aep' %}
                                        <span class="badge bg-info">AEP</span>
                                        {% elif email.type == 'post_window' %}
                                        <span class="badge bg-warning">Post Window</span>
                                        {% else %}
                                        {{ email.type }}
                                        {% endif %}
                                    </td>
                                    <td>{{ email.date }}</td>
                                    <td>
                                        {% if email.skipped == 'Yes' %}
                                        <span class="badge bg-danger">Skipped</span>
                                        {% else %}
                                        <span class="badge bg-success">Scheduled</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if email.type == 'birthday' and contact_data.contact_info.birth_date %}
                                        {% set birthday_parts = contact_data.contact_info.birth_date.split('-') %}
                                        {% set current_year = email.date.split('-')[0] %}
                                        {% set default_date = current_year + '-' + birthday_parts[1] + '-' + birthday_parts[2] %}
                                        {% if email.date < default_date %}
                                            {{ (default_date.split('-')[0]|int - 1)|string + '-' + default_date.split('-')[1] + '-' + default_date.split('-')[2] }}
                                        {% else %}
                                            {{ default_date }}
                                        {% endif %}
                                        {% elif email.type == 'effective_date' and contact_data.contact_info.effective_date %}
                                        {% set effective_parts = contact_data.contact_info.effective_date.split('-') %}
                                        {% set current_year = email.date.split('-')[0] %}
                                        {% set default_date = current_year + '-' + effective_parts[1] + '-' + effective_parts[2] %}
                                        {% if email.date < default_date %}
                                            {{ (default_date.split('-')[0]|int - 1)|string + '-' + default_date.split('-')[1] + '-' + default_date.split('-')[2] }}
                                        {% else %}
                                            {{ default_date }}
                                        {% endif %}
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if email.reason %}
                                        <span class="text-danger">{{ email.reason }}</span>
                                        {% elif email.skipped == 'Yes' %}
                                        <span class="text-danger">Unknown</span>
                                        {% else %}
                                        <span class="text-success">Normal schedule</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="mt-4 mb-4">
    <a href="/" class="btn btn-secondary">Check Another Organization</a>
</div>

<script>
async function resampleContacts() {
    const button = document.querySelector('button');
    const spinner = button.querySelector('.spinner-border');
    const container = document.getElementById('contacts-container');
    const sampleSize = document.querySelector('select[name="sample_size"]').value;
    const state = '{{ selected_state or "" }}';  // Handle null/None case
    const specialRulesOnly = {{ 'true' if special_rules_only else 'false' }};
    
    // Show loading state
    button.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        // Build URL with proper parameters
        let url = `/resample/{{ org_id }}?sample_size=${sampleSize}`;
        if (state) {
            url += `&state=${state}`;
        }
        url += `&special_rules_only=${specialRulesOnly}`;
        
        const response = await fetch(url, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to resample contacts');
        }
        
        const data = await response.json();
        
        // Build new HTML
        let html = '';
        for (const [contactId, contactData] of Object.entries(data.contacts)) {
            const stateInfo = contactData.contact_info.state_info;
            const hasSpecialRules = stateInfo.has_birthday_rule || 
                                  stateInfo.has_effective_date_rule || 
                                  stateInfo.has_year_round_enrollment;
            
            // Function to get rule description
            function getBirthdayRuleDesc(state) {
                if (state === "CA") return "60-day exclusion period: 30 days before and 30 days after birthday.";
                if (state === "ID") return "63-day exclusion period: Starting on birthday and ending 63 days after.";
                if (state === "IL") return "45-day exclusion period: Starting on birthday and ending 45 days after.";
                if (state === "KY") return "60-day exclusion period: Starting on birthday and ending 60 days after.";
                if (state === "LA") return "93-day exclusion period: 30 days before and 63 days after birthday.";
                if (state === "MD") return "31-day exclusion period: Starting on birthday and ending 31 days after.";
                if (state === "NV") return "60-day exclusion period: Starting on first day of birth month.";
                if (state === "OK") return "60-day exclusion period: Starting on birthday and ending 60 days after.";
                if (state === "OR") return "31-day exclusion period: Starting on birthday and ending 31 days after.";
                return "";
            }
            
            function getEffectiveDateRuleDesc(state) {
                if (state === "MO") return "63-day exclusion period: 30 days before and 33 days after the policy anniversary.";
                return "";
            }
            
            // Function to calculate default date
            function getDefaultDate(emailType, emailDate, birthDate, effectiveDate) {
                if (!emailDate) return "N/A";
                
                if (emailType === "birthday" && birthDate) {
                    const dateParts = emailDate.split('-');
                    const birthParts = birthDate.split('-');
                    const currentYear = dateParts[0];
                    const defaultDate = `${currentYear}-${birthParts[1]}-${birthParts[2]}`;
                    
                    // Adjust if email date is before default date
                    if (emailDate < defaultDate) {
                        return `${parseInt(currentYear) - 1}-${birthParts[1]}-${birthParts[2]}`;
                    }
                    return defaultDate;
                }
                
                if (emailType === "effective_date" && effectiveDate) {
                    const dateParts = emailDate.split('-');
                    const effectiveParts = effectiveDate.split('-');
                    const currentYear = dateParts[0];
                    const defaultDate = `${currentYear}-${effectiveParts[1]}-${effectiveParts[2]}`;
                    
                    // Adjust if email date is before default date
                    if (emailDate < defaultDate) {
                        return `${parseInt(currentYear) - 1}-${effectiveParts[1]}-${effectiveParts[2]}`;
                    }
                    return defaultDate;
                }
                
                return "N/A";
            }
                
            html += `
                <div class="card contact-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            ${contactData.contact_info.name}
                            <small class="text-muted">(ID: ${contactData.contact_info.id})</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Email:</strong> ${contactData.contact_info.email}
                            </div>
                            <div class="col-md-4">
                                <strong>Birth Date:</strong> ${contactData.contact_info.birth_date || 'N/A'}
                            </div>
                            <div class="col-md-4">
                                <strong>Effective Date:</strong> ${contactData.contact_info.effective_date || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- State and Rule Info -->
                            <div class="col-md-4">
                                <div class="card border-info mb-3">
                                    <div class="card-header bg-info text-white">
                                        <strong>State: ${contactData.contact_info.state}</strong>
                                        ${hasSpecialRules ? '<span class="badge bg-light text-dark">Special Rules Apply</span>' : ''}
                                    </div>
                                    <div class="card-body">
                                        ${stateInfo.has_year_round_enrollment ? `
                                        <div class="alert alert-warning">
                                            <strong>Year-Round Enrollment State</strong>
                                            <p class="mb-0 small">All emails are skipped because this state allows year-round enrollment.</p>
                                        </div>
                                        ` : ''}
                                        
                                        ${stateInfo.has_birthday_rule ? `
                                        <div class="mb-2">
                                            <strong class="text-primary">Birthday Rule</strong>
                                            <p class="mb-0 small">${getBirthdayRuleDesc(contactData.contact_info.state)}</p>
                                        </div>
                                        ` : ''}
                                        
                                        ${stateInfo.has_effective_date_rule ? `
                                        <div class="mb-2">
                                            <strong class="text-success">Effective Date Rule</strong>
                                            <p class="mb-0 small">${getEffectiveDateRuleDesc(contactData.contact_info.state)}</p>
                                        </div>
                                        ` : ''}
                                        
                                        <div class="mb-0 small text-muted">
                                            <p class="mb-0"><strong>Standard Scheduling Rules:</strong></p>
                                            <ul class="ps-3 mb-0">
                                                <li>Birthday emails: 14 days before birthday</li>
                                                <li>Effective date emails: 30 days before anniversary</li>
                                                <li>AEP emails: Distributed across August/September</li>
                                                <li>Post-window emails: Day after exclusion period</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scheduled Emails Section -->
                            <div class="col-md-8">
                                <h6>Scheduled Emails:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Default Date</th>
                                                <th>Reason</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${contactData.emails.map(email => {
                                                const badgeType = email.type === 'birthday' ? 'primary' : 
                                                                email.type === 'effective_date' ? 'success' :
                                                                email.type === 'aep' ? 'info' : 
                                                                email.type === 'post_window' ? 'warning' : 'secondary';
                                                const emailTypeLabel = email.type === 'birthday' ? 'Birthday' : 
                                                                    email.type === 'effective_date' ? 'Effective Date' :
                                                                    email.type === 'aep' ? 'AEP' : 
                                                                    email.type === 'post_window' ? 'Post Window' : email.type;
                                                
                                                const defaultDate = getDefaultDate(
                                                    email.type, 
                                                    email.date, 
                                                    contactData.contact_info.birth_date, 
                                                    contactData.contact_info.effective_date
                                                );
                                                
                                                return `
                                                <tr ${email.skipped === 'Yes' ? 'class="table-danger"' : ''}>
                                                    <td>
                                                        <span class="badge bg-${badgeType}">${emailTypeLabel}</span>
                                                    </td>
                                                    <td>${email.date}</td>
                                                    <td>
                                                        ${email.skipped === 'Yes' 
                                                            ? '<span class="badge bg-danger">Skipped</span>' 
                                                            : '<span class="badge bg-success">Scheduled</span>'}
                                                    </td>
                                                    <td>${defaultDate}</td>
                                                    <td>
                                                        ${email.reason 
                                                            ? `<span class="text-danger">${email.reason}</span>` 
                                                            : email.skipped === 'Yes' 
                                                                ? '<span class="text-danger">Unknown</span>' 
                                                                : '<span class="text-success">Normal schedule</span>'}
                                                    </td>
                                                </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Update the container
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to resample contacts. Please try again.');
    } finally {
        // Reset loading state
        button.disabled = false;
        spinner.classList.add('d-none');
    }
}
</script>
{% endblock %} 