{% extends "base.html" %}

{% block head %}
<!-- Add vis-timeline CSS -->
<link rel="stylesheet" href="/static/vis-timeline-graph2d.min.css">
<style>
.timeline-container { 
    margin-top: 20px; 
    height: 300px; 
}
.date-birthday { 
    background-color: #ffd700 !important; /* yellow */ 
}
.date-effective { 
    background-color: #ffa500 !important; /* orange */ 
}
.exclusion { 
    background-color: #ff0000 !important; /* red */
    opacity: 0.3; 
}
.email-birthday { 
    background-color: #008000 !important; /* green */ 
}
.email-effective-date { 
    background-color: #0000ff !important; /* blue */ 
}
.email-aep { 
    background-color: #800080 !important; /* purple */ 
}
.email-post-window { 
    background-color: #00ffff !important; /* cyan */ 
}
.timeline-wrapper {
    display: flex;
    margin-top: 20px;
}
.timeline-labels {
    width: 150px;
    padding-right: 10px;
}
.timeline-label {
    height: 60px;
    line-height: 60px;
    font-weight: bold;
    text-align: right;
    padding-right: 10px;
}
.timeline-content {
    flex: 1;
}
.timeline-row {
    height: 60px;
    margin-bottom: 5px;
}
.date-birthday {
    background-color: #ffd700 !important;
    border-color: #b8860b !important;
}
.date-effective {
    background-color: #ffa500 !important;
    border-color: #8b4513 !important;
}
.exclusion {
    background-color: rgba(255, 0, 0, 0.3) !important;
    border-color: #8b0000 !important;
}
.email-birthday {
    background-color: #32cd32 !important;
    border-color: #006400 !important;
}
.email-effective-date {
    background-color: #4169e1 !important;
    border-color: #00008b !important;
}
.email-aep {
    background-color: #9370db !important;
    border-color: #4b0082 !important;
}
.email-post-window {
    background-color: #00ffff !important;
    border-color: #008b8b !important;
}
.email-skipped {
    background-color: #808080 !important;
    border-color: #2f4f4f !important;
}
.vis-item {
    border-width: 2px !important;
    border-radius: 5px !important;
}
.vis-item.vis-point {
    border-width: 3px !important;
}
.vis-item.vis-selected {
    border-color: #000000 !important;
    background-color: inherit !important;
}
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <h2>{{ org_name }} (ID: {{ org_id }})</h2>
    <p class="text-muted">
        Showing {{ sample_size }} contacts out of {{ total_contacts }} total contacts
        {% if selected_state %}
        (Filtered by state: {{ selected_state }})
        {% elif special_rules_only %}
        (Showing only states with special rules)
        {% endif %}
        {% if contact_search %}
        (Searching for: {{ contact_search }})
        {% endif %}
    </p>
    
    <form action="/check" method="post" class="d-inline">
        <input type="hidden" name="org_id" value="{{ org_id }}">
        <input type="hidden" name="state" value="{{ selected_state }}">
        <input type="hidden" name="special_rules_only" value="{{ 'true' if special_rules_only else 'false' }}">
        <select class="form-select form-select-sm d-inline w-auto" name="sample_size" onchange="this.form.submit()">
            {% for size in sample_sizes %}
            <option value="{{ size }}" {% if size == sample_size %}selected{% endif %}>Show {{ size }} contacts</option>
            {% endfor %}
        </select>
    </form>
    
    <button class="btn btn-primary btn-sm ms-2" onclick="resampleContacts()">
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        Resample Contacts
    </button>
</div>

<div id="contacts-container">
    {% for contact_id, contact_data in contacts.items() %}
    <div class="card contact-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                {{ contact_data.contact_info.name }}
                <small class="text-muted">(ID: {{ contact_data.contact_info.id }})</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>Email:</strong> {{ contact_data.contact_info.email }}
                </div>
                <div class="col-md-4">
                    <strong>Birth Date:</strong> {{ contact_data.contact_info.birth_date or 'N/A' }}
                </div>
                <div class="col-md-4">
                    <strong>Effective Date:</strong> {{ contact_data.contact_info.effective_date or 'N/A' }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    {% include "state_info.html" %}
                </div>
                <div class="col-md-8">
                    {% include "email_table.html" %}
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <h6>Timeline View:</h6>
                    <div class="timeline-wrapper">
                        <div class="timeline-labels">
                            <div class="timeline-label">Exclusion Periods</div>
                            <div class="timeline-label">Birthdays</div>
                            <div class="timeline-label">Effective Dates</div>
                            <div class="timeline-label">Scheduled Emails</div>
                            <div class="timeline-label">Skipped Emails</div>
                        </div>
                        <div class="timeline-content">
                            <div id="timeline-exclusions-{{ contact_data.contact_info.id }}" class="timeline-row"></div>
                            <div id="timeline-birthdays-{{ contact_data.contact_info.id }}" class="timeline-row"></div>
                            <div id="timeline-effective-dates-{{ contact_data.contact_info.id }}" class="timeline-row"></div>
                            <div id="timeline-scheduled-{{ contact_data.contact_info.id }}" class="timeline-row"></div>
                            <div id="timeline-skipped-{{ contact_data.contact_info.id }}" class="timeline-row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="mt-4 mb-4">
    <a href="/" class="btn btn-secondary">Check Another Organization</a>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/vis-timeline-graph2d.min.js"></script>
<script>
function createTimeline(containerId, items, options) {
    var container = document.getElementById(containerId);
    var dataset = new vis.DataSet(items);
    var timeline = new vis.Timeline(container, dataset, options);
    
    timeline.on('mouseOver', function(properties) {
        var item = dataset.get(properties.item);
        if (item && item.tooltip) {
            var element = document.getElementById(properties.item);
            if (element) {
                element.title = item.tooltip;
            }
        }
    });
}

var baseOptions = {
    start: '{{ current_date }}',
    end: '{{ end_date }}',
    height: '60px',
    zoomable: false,
    selectable: false,
    showCurrentTime: false,
    stack: false,
    verticalScroll: false,
    horizontalScroll: true
};

{% for contact_id, contact_data in contacts.items() %}
createTimeline('timeline-exclusions-{{ contact_data.contact_info.id }}', {{ contact_data.timeline_exclusions | tojson }}, Object.assign({}, baseOptions));
createTimeline('timeline-birthdays-{{ contact_data.contact_info.id }}', {{ contact_data.timeline_birthdays | tojson }}, Object.assign({}, baseOptions));
createTimeline('timeline-effective-dates-{{ contact_data.contact_info.id }}', {{ contact_data.timeline_effective_dates | tojson }}, Object.assign({}, baseOptions));
createTimeline('timeline-scheduled-{{ contact_data.contact_info.id }}', {{ contact_data.timeline_scheduled | tojson }}, Object.assign({}, baseOptions));
createTimeline('timeline-skipped-{{ contact_data.contact_info.id }}', {{ contact_data.timeline_skipped | tojson }}, Object.assign({}, baseOptions));
{% endfor %}

async function resampleContacts() {
    const button = document.querySelector('button');
    const spinner = button.querySelector('.spinner-border');
    const container = document.getElementById('contacts-container');
    const sampleSize = document.querySelector('select[name="sample_size"]').value;
    const state = '{{ selected_state or "" }}';
    const specialRulesOnly = {{ 'true' if special_rules_only else 'false' }};
    const contactSearch = '{{ contact_search or "" }}';
    
    button.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        let url = `/resample/{{ org_id }}?sample_size=${sampleSize}`;
        if (state) {
            url += `&state=${state}`;
        }
        url += `&special_rules_only=${specialRulesOnly}`;
        if (contactSearch) {
            url += `&contact_search=${encodeURIComponent(contactSearch)}`;
        }
        
        const response = await fetch(url, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to resample contacts');
        }
        
        location.reload();
    } catch (error) {
        console.error('Error resampling contacts:', error);
        alert('Failed to resample contacts. Please try again.');
    } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
    }
}
</script>
{% endblock %}