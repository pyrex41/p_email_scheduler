{% extends "base.html" %}

{% block head %}
<!-- Add vis-timeline CSS -->
<link rel="stylesheet" href="/static/vis-timeline-graph2d.min.css">
<style>
.timeline-container { 
    margin-top: 20px; 
    height: 300px; 
}
.date-birthday { 
    background-color: #ffd700 !important; /* yellow */ 
}
.date-effective { 
    background-color: #ffa500 !important; /* orange */ 
}
.exclusion { 
    background-color: #ff0000 !important; /* red */
    opacity: 0.3; 
}
.email-birthday { 
    background-color: #008000 !important; /* green */ 
}
.email-effective-date { 
    background-color: #0000ff !important; /* blue */ 
}
.email-aep { 
    background-color: #800080 !important; /* purple */ 
}
.email-post-window { 
    background-color: #00ffff !important; /* cyan */ 
}
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <h2>{{ org_name }} (ID: {{ org_id }})</h2>
    <p class="text-muted">
        Showing {{ sample_size }} contacts out of {{ total_contacts }} total contacts
        {% if selected_state %}
        (Filtered by state: {{ selected_state }})
        {% elif special_rules_only %}
        (Showing only states with special rules)
        {% endif %}
        {% if contact_search %}
        (Searching for: {{ contact_search }})
        {% endif %}
    </p>
    
    <form action="/check" method="post" class="d-inline">
        <input type="hidden" name="org_id" value="{{ org_id }}">
        <input type="hidden" name="state" value="{{ selected_state }}">
        <input type="hidden" name="special_rules_only" value="{{ 'true' if special_rules_only else 'false' }}">
        <select class="form-select form-select-sm d-inline w-auto" name="sample_size" onchange="this.form.submit()">
            {% for size in sample_sizes %}
            <option value="{{ size }}" {% if size == sample_size %}selected{% endif %}>Show {{ size }} contacts</option>
            {% endfor %}
        </select>
    </form>
    
    <button class="btn btn-primary btn-sm ms-2" onclick="resampleContacts()">
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        Resample Contacts
    </button>
</div>

<div id="contacts-container">
    {% for contact_id, contact_data in contacts.items() %}
    <div class="card contact-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                {{ contact_data.contact_info.name }}
                <small class="text-muted">(ID: {{ contact_data.contact_info.id }})</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>Email:</strong> {{ contact_data.contact_info.email }}
                </div>
                <div class="col-md-4">
                    <strong>Birth Date:</strong> {{ contact_data.contact_info.birth_date or 'N/A' }}
                </div>
                <div class="col-md-4">
                    <strong>Effective Date:</strong> {{ contact_data.contact_info.effective_date or 'N/A' }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    {% include "state_info.html" %}
                </div>
                <div class="col-md-8">
                    {% include "email_table.html" %}
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <h6>Timeline View:</h6>
                    <div id="timeline-{{ contact_data.contact_info.id }}" class="timeline-container"></div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="mt-4 mb-4">
    <a href="/" class="btn btn-secondary">Check Another Organization</a>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/vis-timeline-graph2d.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for contact_id, contact_data in contacts.items() %}
    (function() {
        const container = document.getElementById('timeline-{{ contact_data.contact_info.id }}');
        const items = new vis.DataSet({{ contact_data.timeline_data | tojson | safe }});
        const options = {
            start: '{{ current_date }}',
            end: '{{ end_date }}',
            height: '300px',
            zoomMin: 1000 * 60 * 60 * 24 * 30,
            zoomMax: 1000 * 60 * 60 * 24 * 365 * 3,
            tooltip: {
                followMouse: true,
                overflowMethod: 'cap'
            },
            template: function(item) {
                return item.content;
            }
        };
        const timeline = new vis.Timeline(container, items, options);
    })();
    {% endfor %}
});

async function resampleContacts() {
    const button = document.querySelector('button');
    const spinner = button.querySelector('.spinner-border');
    const container = document.getElementById('contacts-container');
    const sampleSize = document.querySelector('select[name="sample_size"]').value;
    const state = '{{ selected_state or "" }}';
    const specialRulesOnly = {{ 'true' if special_rules_only else 'false' }};
    const contactSearch = '{{ contact_search or "" }}';
    
    button.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        let url = `/resample/{{ org_id }}?sample_size=${sampleSize}`;
        if (state) {
            url += `&state=${state}`;
        }
        url += `&special_rules_only=${specialRulesOnly}`;
        if (contactSearch) {
            url += `&contact_search=${encodeURIComponent(contactSearch)}`;
        }
        
        const response = await fetch(url, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to resample contacts');
        }
        
        location.reload();
    } catch (error) {
        console.error('Error resampling contacts:', error);
        alert('Failed to resample contacts. Please try again.');
    } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
    }
}
</script>
{% endblock %}